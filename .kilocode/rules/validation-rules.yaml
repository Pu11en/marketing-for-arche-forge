# Validation Rules for Spec-Kit Mode
# Defines comprehensive validation rules and error handling for each workflow phase

# Global validation settings
global_settings:
  strict_mode: true
  fail_fast: false
  max_warnings: 10
  output_format: "structured"  # Options: simple, structured, detailed

# Phase-specific validation rules
phases:
  specify:
    name: "Specification"
    description: "Transform user idea into structured specification"
    
    # Prerequisites for this phase
    prerequisites:
      - name: "repository_initialized"
        description: "Repository must be initialized with git"
        validator: "git_status"
        required: true
        
    # Quality gates for this phase
    quality_gates:
      - id: "no_implementation_details"
        name: "No Implementation Details"
        description: "Specification must not contain implementation details"
        severity: "error"
        validator:
          type: "content_pattern"
          pattern: "database|API|endpoint|function|class|method|variable"
          pattern_type: "forbidden"
          context: "technical_terms"
        message: "Specification contains implementation details. Focus on WHAT users need, not HOW to implement."
        suggestions:
          - "Remove technical implementation details"
          - "Focus on user requirements and business needs"
          - "Use user-friendly language instead of technical terms"
          
      - id: "measurable_success_criteria"
        name: "Measurable Success Criteria"
        description: "Success criteria must be measurable and technology-agnostic"
        severity: "error"
        validator:
          type: "content_analysis"
          check: "success_criteria_measurable"
        message: "Success criteria are not measurable or contain implementation details."
        suggestions:
          - "Add specific metrics (time, percentage, count)"
          - "Remove technology-specific references"
          - "Focus on user outcomes rather than system internals"
          
      - id: "complete_user_stories"
        name: "Complete User Stories"
        description: "All user stories must be complete with acceptance criteria"
        severity: "error"
        validator:
          type: "content_pattern"
          pattern: "User Story \d+"
          pattern_type: "required"
          min_count: 1
        message: "Specification must contain at least one complete user story."
        suggestions:
          - "Add user stories with clear acceptance criteria"
          - "Ensure each story has independent test capability"
          - "Include edge cases and error scenarios"
          
      - id: "max_3_ambiguities"
        name: "Maximum 3 Ambiguities"
        description: "Maximum 3 clarification markers allowed"
        severity: "warning"
        validator:
          type: "content_pattern"
          pattern: "\[NEEDS CLARIFICATION:"
          pattern_type: "count"
          max_count: 3
        message: "Too many clarification markers. Maximum allowed is 3."
        suggestions:
          - "Prioritize the most critical clarifications"
          - "Make reasonable assumptions for less critical items"
          - "Document assumptions in the Assumptions section"
          
    # Error recovery strategies
    error_recovery:
      - error_type: "missing_user_stories"
        strategy: "guided_creation"
        actions:
          - "Provide user story template"
          - "Suggest common user story patterns"
          - "Offer examples from similar features"
          
      - error_type: "implementation_details_detected"
        strategy: "content_refactoring"
        actions:
          - "Highlight implementation details"
          - "Suggest user-focused alternatives"
          - "Provide rewrite examples"
          
      - error_type: "unmeasurable_criteria"
        strategy: "metric_guidance"
        actions:
          - "Provide metric examples"
          - "Suggest measurement approaches"
          - "Offer success criteria templates"

  clarify:
    name: "Clarification"
    description: "Resolve ambiguities and refine requirements"
    
    prerequisites:
      - name: "specification_exists"
        description: "Specification file must exist"
        validator: "file_exists"
        path: "specs/{feature}/spec.md"
        required: true
        
      - name: "specification_quality"
        description: "Specification must pass basic quality checks"
        validator: "phase_validation"
        phase: "specify"
        required: true
        
    quality_gates:
      - id: "max_3_ambiguities_remaining"
        name: "Maximum 3 Remaining Ambiguities"
        description: "Maximum 3 ambiguities may remain after clarification"
        severity: "error"
        validator:
          type: "content_pattern"
          pattern: "\[NEEDS CLARIFICATION:"
          pattern_type: "count"
          max_count: 3
        message: "Too many ambiguities remain after clarification."
        suggestions:
          - "Address the most critical ambiguities first"
          - "Make reasonable assumptions for less critical items"
          - "Document assumptions for future reference"
          
      - id: "all_critical_questions_answered"
        name: "Critical Questions Answered"
        description: "All critical questions must be answered"
        severity: "error"
        validator:
          type: "content_analysis"
          check: "critical_questions_answered"
        message: "Critical questions remain unanswered."
        suggestions:
          - "Review all NEEDS CLARIFICATION markers"
          - "Prioritize security and scope questions"
          - "Document decisions with rationale"

  plan:
    name: "Planning"
    description: "Create technical implementation plan"
    
    prerequisites:
      - name: "clarification_complete"
        description: "Clarification phase must be completed"
        validator: "phase_status"
        phase: "clarify"
        status: "passed"
        required: true
        
    quality_gates:
      - id: "constitution_compliance"
        name: "Constitution Compliance"
        description: "Plan must comply with project constitution"
        severity: "error"
        validator:
          type: "constitution_check"
          constitution_file: "temp-spec-kit/memory/constitution.md"
        message: "Plan violates project constitution principles."
        suggestions:
          - "Review constitution constraints"
          - "Provide justification for violations"
          - "Consider alternative approaches"
          
      - id: "technical_decisions_documented"
        name: "Technical Decisions Documented"
        description: "All technical decisions must be documented"
        severity: "error"
        validator:
          type: "content_analysis"
          check: "technical_decisions_documented"
        message: "Technical decisions are not properly documented."
        suggestions:
          - "Document decision rationale"
          - "Include alternatives considered"
          - "Add trade-off analysis"
          
      - id: "research_complete"
        name: "Research Complete"
        description: "All research items must be resolved"
        severity: "error"
        validator:
          type: "content_pattern"
          pattern: "NEEDS CLARIFICATION"
          pattern_type: "forbidden"
        message: "Research phase incomplete with unresolved items."
        suggestions:
          - "Complete all research tasks"
          - "Document findings in research.md"
          - "Resolve all technical unknowns"

  tasks:
    name: "Task Generation"
    description: "Break down implementation into executable tasks"
    
    prerequisites:
      - name: "plan_complete"
        description: "Planning phase must be completed"
        validator: "phase_status"
        phase: "plan"
        status: "passed"
        required: true
        
    quality_gates:
      - id: "user_story_coverage_complete"
        name: "User Story Coverage Complete"
        description: "All user stories must have corresponding tasks"
        severity: "error"
        validator:
          type: "coverage_analysis"
          source: "spec.md"
          target: "tasks.md"
          coverage_type: "user_stories"
        message: "Not all user stories are covered by tasks."
        suggestions:
          - "Add tasks for uncovered user stories"
          - "Ensure task mapping is complete"
          - "Verify task granularity"
          
      - id: "dependency_graph_valid"
        name: "Dependency Graph Valid"
        description: "Task dependencies must be valid"
        severity: "error"
        validator:
          type: "dependency_analysis"
          check: "circular_dependencies"
        message: "Task dependencies contain cycles or are invalid."
        suggestions:
          - "Resolve circular dependencies"
          - "Document task dependencies clearly"
          - "Consider task reordering"
          
      - id: "mvp_tasks_identified"
        name: "MVP Tasks Identified"
        description: "MVP tasks must be clearly identified"
        severity: "warning"
        validator:
          type: "content_analysis"
          check: "mvp_tasks_identified"
        message: "MVP tasks are not clearly identified."
        suggestions:
          - "Mark MVP tasks with priority indicators"
          - "Group MVP tasks in separate phase"
          - "Document MVP delivery criteria"

  analyze:
    name: "Analysis"
    description: "Quality analysis and validation"
    
    prerequisites:
      - name: "tasks_complete"
        description: "Task generation must be completed"
        validator: "phase_status"
        phase: "tasks"
        status: "passed"
        required: true
        
    quality_gates:
      - id: "no_critical_issues"
        name: "No Critical Issues"
        description: "No critical issues should be found"
        severity: "error"
        validator:
          type: "issue_analysis"
          severity_threshold: "critical"
          max_count: 0
        message: "Critical issues found that must be resolved."
        suggestions:
          - "Address all critical issues before implementation"
          - "Review issue impact and priority"
          - "Create mitigation strategies"
          
      - id: "coverage_adequate"
        name: "Coverage Adequate"
        description: "Test coverage must be adequate"
        severity: "warning"
        validator:
          type: "coverage_analysis"
          coverage_type: "test"
          min_percentage: 80
        message: "Test coverage is below recommended threshold."
        suggestions:
          - "Add unit tests for core functionality"
          - "Include integration tests"
          - "Add end-to-end test scenarios"
          
      - id: "security_reviewed"
        name: "Security Reviewed"
        description: "Security considerations must be reviewed"
        severity: "error"
        validator:
          type: "checklist_review"
          checklist: "security"
          min_completion: 100
        message: "Security review is incomplete."
        suggestions:
          - "Complete security checklist"
          - "Address security concerns"
          - "Document security decisions"

  implement:
    name: "Implementation"
    description: "Execute the implementation plan"
    
    prerequisites:
      - name: "analysis_complete"
        description: "Analysis phase must be completed"
        validator: "phase_status"
        phase: "analyze"
        status: "passed"
        required: true
        
    quality_gates:
      - id: "tests_pass"
        name: "Tests Pass"
        description: "All tests must pass"
        severity: "error"
        validator:
          type: "test_execution"
          failure_threshold: 0
        message: "Some tests are failing."
        suggestions:
          - "Fix failing tests"
          - "Review test failures"
          - "Update tests if requirements changed"
          
      - id: "specification_met"
        name: "Specification Met"
        description: "Implementation must meet specification"
        severity: "error"
        validator:
          type: "compliance_check"
          specification: "specs/{feature}/spec.md"
        message: "Implementation does not meet specification requirements."
        suggestions:
          - "Review specification gaps"
          - "Implement missing requirements"
          - "Update specification if needed"
          
      - id: "quality_checks_passed"
        name: "Quality Checks Passed"
        description: "All quality checks must pass"
        severity: "warning"
        validator:
          type: "quality_gate"
          min_pass_rate: 90
        message: "Quality checks are not passing at required rate."
        suggestions:
          - "Address quality check failures"
          - "Review code quality metrics"
          - "Improve test coverage"

# Error handling strategies
error_handling:
  # Common error types and handling strategies
  strategies:
    - error_type: "missing_prerequisites"
      strategy: "guided_recovery"
      actions:
        - "Identify missing prerequisites"
        - "Provide step-by-step recovery instructions"
        - "Offer to run missing phases automatically"
        
    - error_type: "quality_gate_failure"
      strategy: "interactive_resolution"
      actions:
        - "Present specific issues found"
        - "Offer fix suggestions"
        - "Provide override options with justification"
        
    - error_type: "constitution_violation"
      strategy: "strict_enforcement"
      actions:
        - "Block progress until resolved"
        - "Require explicit justification"
        - "Document violation for review"
        
    - error_type: "script_execution_failure"
      strategy: "graceful_degradation"
      actions:
        - "Log detailed error information"
        - "Attempt fallback methods"
        - "Provide manual workarounds"

# Validation output formats
output_formats:
  simple:
    format: "text"
    details: "minimal"
    include_suggestions: true
    
  structured:
    format: "json"
    details: "comprehensive"
    include_suggestions: true
    include_metadata: true
    
  detailed:
    format: "markdown"
    details: "extensive"
    include_suggestions: true
    include_examples: true
    include_metadata: true

# Validation configuration
configuration:
  # Validation thresholds
  thresholds:
    max_errors: 0
    max_warnings: 5
    max_info: 20
    
  # Validation behavior
  behavior:
    continue_on_warnings: true
    fail_fast_on_errors: false
    auto_fix_minor_issues: true
    
  # Reporting
  reporting:
    include_passing_checks: false
    group_by_severity: true
    sort_by_importance: true
    include_fix_suggestions: true